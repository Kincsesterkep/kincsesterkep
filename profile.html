<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Profile ‚Ä¢ Kincsest√©rk√©p</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Reuse your auth aesthetic for cards */
    :root{
      --surface:#121624; --card:#161b33; --text:#e8eaf6; --border:#2a2f45; --muted:#b7bfd6;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.08);
      border: 1px solid rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: dark){
      body{ background:#0b0f1d; color:var(--text) }
      .card { background: var(--card); border:1px solid var(--border); }
    }
    /* Tabs */
    .tab-btn[aria-selected="true"]{
      background:#f59e0b; color:white;
    }
    /* Form look aligned with your modal forms */
    .set-form{ display:grid; gap:14px; }
    .set-form label{ display:grid; gap:6px; font-weight:600; }
    .set-form input{
      background:#fff; border:1px solid #d1d5db; border-radius:10px; padding:10px 12px; color:#111827;
    }
    @media (prefers-color-scheme: dark){
      .set-form input{ background:#0c1022; color:var(--text); border:1px solid var(--border);}
    }
    .status-line{ min-height:1.25rem; font-size:.95rem; color:#6b7280 }
    @media (prefers-color-scheme: dark){ .status-line{ color:var(--muted);} }
  </style>
</head>
<body class="bg-amber-50 font-sans min-h-screen flex flex-col">

  <!-- Top Nav (same style as home) -->
  <nav class="bg-amber-900 text-amber-50 shadow-lg sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <a href="/" class="flex items-center space-x-2">
        <i class="fas fa-map-marked-alt text-2xl"></i>
        <span class="text-xl font-bold">Kincsest√©rk√©p</span>
      </a>
      <div class="hidden md:flex space-x-6">
        <a href="/" class="hover:text-amber-200 transition">Home</a>
        <a href="/#competitions" class="hover:text-amber-200 transition">Competitions</a>
        <a href="/#about" class="hover:text-amber-200 transition">About</a>
        <a href="/#faq" class="hover:text-amber-200 transition">FAQ</a>
      </div>
      <button class="md:hidden text-xl" id="mobile-menu-button">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="md:hidden hidden bg-amber-800 px-4 py-2" id="mobile-menu">
      <a href="/" class="block py-2 hover:text-amber-200">Home</a>
      <a href="/#competitions" class="block py-2 hover:text-amber-200">Competitions</a>
      <a href="/#about" class="block py-2 hover:text-amber-200">About</a>
      <a href="/#faq" class="block py-2 hover:text-amber-200">FAQ</a>
    </div>
  </nav>

  <!-- Header -->
  <header class="bg-amber-100 border-b border-amber-200">
    <div class="container mx-auto px-4 py-8">
      <h1 class="text-3xl md:text-4xl font-bold text-amber-900">My Profile</h1>
      <p class="text-amber-800 mt-1" id="helloLine">Loading‚Ä¶</p>
    </div>
  </header>

  <!-- Page Body -->
  <main class="container mx-auto px-4 py-8 grow">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Sidebar -->
      <aside class="card p-4 lg:p-5 h-fit">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full grid place-items-center bg-amber-200 text-amber-900">üë§</div>
          <div class="leading-tight">
            <div class="font-semibold" id="userName">User</div>
            <div class="text-sm text-gray-500" id="userEmail">email@example.com</div>
          </div>
        </div>
        <div class="mt-4 grid gap-2">
          <button class="tab-btn w-full text-left px-3 py-2 rounded-md hover:bg-amber-50"
                  data-tab="settings" aria-selected="true">
            <i class="fa-solid fa-gear mr-2"></i> Settings
          </button>
          <button class="tab-btn w-full text-left px-3 py-2 rounded-md hover:bg-amber-50"
                  data-tab="mycomps" aria-selected="false">
            <i class="fa-solid fa-treasure-chest mr-2"></i> My Competitions
          </button>
          <button id="logoutBtn" class="mt-2 w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold px-3 py-2 rounded-md">
            Log out
          </button>
        </div>
      </aside>

      <!-- Content -->
      <section class="lg:col-span-3 space-y-6">
        <!-- Settings -->
        <div class="card p-5" data-panel="settings">
          <h2 class="text-2xl font-bold mb-2">Settings</h2>
          <p class="text-gray-600 mb-4">Update your public username or change your password.</p>

          <div class="grid md:grid-cols-2 gap-6">
            <!-- Username -->
            <div>
              <h3 class="font-semibold mb-3">Update Username</h3>
              <form id="usernameForm" class="set-form">
                <label>
                  New username
                  <input name="username" type="text" minlength="3" maxlength="24" placeholder="e.g. TreasureHunter42" />
                </label>
                <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded-md">
                  Save username
                </button>
                <p class="status-line" id="usernameStatus"></p>
              </form>
            </div>

            <!-- Password -->
            <div>
              <h3 class="font-semibold mb-3">Change Password</h3>
              <form id="passwordForm" class="set-form">
                <label>
                  New password
                  <input name="password" type="password" minlength="8" placeholder="Minimum 8 characters" />
                </label>
                <label>
                  Confirm new password
                  <input name="confirm" type="password" />
                </label>
                <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded-md">
                  Update password
                </button>
                <p class="status-line" id="passwordStatus"></p>
              </form>
            </div>
          </div>
        </div>

        <!-- My Competitions -->
        <div class="card p-5" data-panel="mycomps" hidden>
          <h2 class="text-2xl font-bold mb-2">My Competitions</h2>
          <p class="text-gray-600 mb-4">Only competitions you‚Äôve signed up for will appear here.</p>

          <div id="compsEmpty" class="text-gray-500">
            You have no paid competitions yet.
          </div>

          <div id="compsList" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer (same style family) -->
  <footer class="bg-amber-900 text-amber-200 mt-8">
    <div class="container mx-auto px-4 py-6 text-sm flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <i class="fas fa-map-marked-alt"></i>
        <span>Kincsest√©rk√©p</span>
      </div>
      <div>&copy; <span id="yr"></span> Kincsest√©rk√©p. All rights reserved.</div>
    </div>
  </footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== Mobile nav toggle (reused)
    document.getElementById('mobile-menu-button')?.addEventListener('click', () => {
      document.getElementById('mobile-menu')?.classList.toggle('hidden');
    });

    // ===== Supabase config (use the same values as your home page)
    const SUPABASE_URL = "https://nwdoflrxaxjutbhhceyw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53ZG9mbHJ4YXhqdXRiaGhjZXl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NDUyOTEsImV4cCI6MjA3NzAyMTI5MX0.RTgzc0lkIVtm6TCtcnL-nktetP7UXZutDauXuZ29iNQ";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Elements
    const helloLine = document.getElementById('helloLine');
    const userName  = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');

    const usernameForm   = document.getElementById('usernameForm');
    const usernameStatus = document.getElementById('usernameStatus');

    const passwordForm   = document.getElementById('passwordForm');
    const passwordStatus = document.getElementById('passwordStatus');

    const tabs  = Array.from(document.querySelectorAll('.tab-btn'));
    const panels= Array.from(document.querySelectorAll('[data-panel]'));

    const compsList  = document.getElementById('compsList');
    const compsEmpty = document.getElementById('compsEmpty');

    // ===== Tabs
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = btn.dataset.tab;
        tabs.forEach(b => b.setAttribute('aria-selected', String(b===btn)));
        panels.forEach(p => p.hidden = (p.dataset.panel !== target));
      });
    });

    // ===== Auth bootstrap / guard
    (async function init(){
      const { data } = await sb.auth.getSession();
      const user = data?.session?.user;
      if(!user){
        // Not signed in ‚Üí bounce to home and (optionally) ask to log in
        window.location.href = "/#login-required";
        return;
      }
      paintUser(user);
      await loadCompetitions(user);
    })();

    // Keep UI refreshed if the session changes
    sb.auth.onAuthStateChange((_evt, session) => {
      const user = session?.user;
      if(!user){ window.location.href = "/"; return; }
      paintUser(user);
    });

    function labelFromUser(user){
      const uname = user?.user_metadata?.username;
      return (uname && String(uname).trim()) ? uname : (user?.email || "User");
    }
    function paintUser(user){
      userName.textContent  = labelFromUser(user);
      userEmail.textContent = user?.email || "";
      document.title = `${labelFromUser(user)} ‚Ä¢ My Profile`;
      document.getElementById('yr').textContent = new Date().getFullYear();
    }

    // ===== Username update (user_metadata)
    usernameForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      usernameStatus.textContent = "Saving‚Ä¶";
      const fd = new FormData(usernameForm);
      const username = String(fd.get('username')||'').trim();

      if(username && !/^[a-z0-9_. \-]{3,24}$/i.test(username)){
        usernameStatus.textContent = "Use 3‚Äì24 chars: letters, numbers, space, .-_";
        return;
      }
      try{
        const { data } = await sb.auth.getUser();
        if(!data?.user){ throw new Error("Not signed in."); }

        const { error } = await sb.auth.updateUser({ data: username ? { username } : {} });
        if(error) throw error;

        usernameStatus.textContent = "Username updated.";
        paintUser({ ...data.user, user_metadata: { ...data.user.user_metadata, username }});
        usernameForm.reset();
      }catch(err){
        usernameStatus.textContent = err?.message || "Failed to update username.";
      }
    });

    // ===== Password update
    passwordForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      passwordStatus.textContent = "Updating password‚Ä¶";
      const fd = new FormData(passwordForm);
      const p = String(fd.get('password')||'');
      const c = String(fd.get('confirm')||'');

      if(p.length < 8){ passwordStatus.textContent = "Password must be at least 8 characters."; return; }
      if(p !== c){ passwordStatus.textContent = "Passwords do not match."; return; }

      try{
        const { error } = await sb.auth.updateUser({ password: p });
        if(error) throw error;
        passwordStatus.textContent = "Password updated successfully.";
        passwordForm.reset();
      }catch(err){
        passwordStatus.textContent = err?.message || "Failed to update password.";
      }
    });

    // ===== Log out
    logoutBtn?.addEventListener('click', async () => {
      await sb.auth.signOut();
      window.location.href = "/";
    });

    // ===== Competitions (paid only)
    // Create a table in Supabase called 'signups' with (recommended):
    //   id uuid primary key default gen_random_uuid()
    //   user_id uuid references auth.users(id) on delete cascade
    //   competition_slug text
    //   competition_title text
    //   paid boolean default false
    //   paid_at timestamptz
    // Then RLS policy to allow: user can select rows where user_id = auth.uid()
    async function loadCompetitions(user){
      try{
        // Only show paid = true
        const { data, error } = await sb
          .from('signups')
          .select('id, competition_slug, competition_title, paid, paid_at')
          .eq('user_id', user.id)
          .eq('paid', true)
          .order('paid_at', { ascending:false });

        if(error) throw error;

        compsList.innerHTML = "";
        const has = Array.isArray(data) && data.length > 0;
        compsEmpty.classList.toggle('hidden', has);

        if(has){
          data.forEach(row => {
            const card = document.createElement('div');
            card.className = "p-4 rounded-xl border border-amber-200 bg-amber-50";
            card.innerHTML = `
              <div class="font-semibold text-amber-900">${row.competition_title || row.competition_slug}</div>
              <div class="text-sm text-amber-800 mt-1">Paid on: ${row.paid_at ? new Date(row.paid_at).toLocaleString() : "‚Äî"}</div>
              <div class="mt-3">
                <a href="/#competitions" class="text-amber-700 hover:underline">View details</a>
              </div>
            `;
            compsList.appendChild(card);
          });
        }
      }catch(err){
        compsEmpty.textContent = "Could not load competitions.";
        console.error(err);
      }
    }
  </script>
</body>
</html>